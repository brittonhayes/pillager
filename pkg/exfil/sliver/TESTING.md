# Sliver Exfiltration Testing Guide (For Developers)

> **Note**: This document is for **developers** who want to test the Sliver integration code.
> 
> **End-users**: If you want to use the `pillager` binary with Sliver C2, see [README.md](README.md) instead.

## Overview

This guide covers testing the Sliver C2 exfiltration functionality during development. The test suite includes both **mock-based integration tests** (run by default) and **real Sliver C2 instance tests** (opt-in).

## Running Tests

### Mock-Based Integration Tests (Default)

These tests verify the complete exfiltration workflow using a mock RPC client without requiring a real Sliver server:

```bash
go test -v ./pkg/exfil/sliver/...
```

The integration tests verify:
- Full exfiltration flow from findings to Sliver loot storage
- Credential parsing and storage in Sliver's credential store
- JSON serialization and package metadata
- Multiple credential types (AWS, GitHub, SSH, API tokens, Database credentials)
- Error handling and edge cases

### Real Sliver C2 Instance Tests (Optional)

To test against an actual Sliver C2 server:

#### 1. Set up a Sliver Server

```bash
# Start the Sliver server
sliver-server
```

#### 2. Generate an Operator Configuration

**IMPORTANT**: Client configurations MUST be generated by the server. They contain per-user key pairs and cannot be manually created.

```bash
# In the Sliver console, create an operator config
sliver > new-operator --name test-operator --lhost <your-ip> --lport 31337
```

This will generate a JSON configuration file with the following structure:
```json
{
  "operator": "test-operator",
  "lhost": "localhost",
  "lport": 31337,
  "ca_certificate": "-----BEGIN CERTIFICATE-----\n...",
  "private_key": "-----BEGIN EC PRIVATE KEY-----\n...",
  "certificate": "-----BEGIN CERTIFICATE-----\n..."
}
```

The configuration file will be saved to the Sliver configs directory (typically `~/.sliver-client/configs/test-operator_*.cfg`).

**Note**: The `operator` field only modifies the display name in the client. The server identifies users by the CommonName in the certificate.

#### 3. Copy the Configuration (if needed)

The generated config file can be copied to `~/.sliver-client/configs/` if it's not already there:

```bash
# Linux/Mac
cp /path/to/test-operator_*.cfg ~/.sliver-client/configs/

# Windows (PowerShell)
Copy-Item "C:\path\to\test-operator_*.cfg" "$HOME\.sliver-client\configs\"
```

#### 4. Run the Real Instance Test

Set the `SLIVER_CONFIG_PATH` environment variable to the full path of the generated config file:

```bash
# Linux/Mac (use the exact filename generated by Sliver)
export SLIVER_CONFIG_PATH=~/.sliver-client/configs/test-operator_192.168.1.100.cfg
go test -v -run TestRealSliverInstance ./pkg/exfil/sliver/

# Windows (PowerShell)
$env:SLIVER_CONFIG_PATH="$HOME\.sliver-client\configs\test-operator_192.168.1.100.cfg"
go test -v -run TestRealSliverInstance ./pkg/exfil/sliver/
```

**Important**: Use the exact filename generated by the server. The filename typically follows the format `<operator-name>_<lhost>.cfg`.

#### 5. Verify Results in Sliver

After the test completes, check your Sliver server to verify the exfiltrated data:

```bash
sliver > loot        # View stored loot
sliver > creds       # View stored credentials
```

You should see entries like:
- Loot files named `pillager-test-YYYYMMDD-HHMMSS.json`
- Credentials with names like `AWS-AWS_ACCESS_KEY_ID`, `GitHub-GitHub Personal Access Token`, etc.

## Client Configuration Format

Sliver client configurations are JSON files that **must be generated by the server**. They cannot be manually created or edited (except for the `operator` display name).

### Configuration Structure

```json
{
  "operator": "test-operator",       // Display name only
  "lhost": "192.168.1.100",          // Server host
  "lport": 31337,                    // Server port
  "ca_certificate": "...",           // PEM-encoded CA certificate
  "private_key": "...",              // PEM-encoded ECDSA private key
  "certificate": "..."               // PEM-encoded client certificate
}
```

### Configuration Fields

- **operator**: Display name shown in the client (can be modified, doesn't affect authentication)
- **lhost/lport**: Server connection details
- **ca_certificate**: Server's CA certificate for TLS verification
- **private_key**: Client's private key for mTLS authentication
- **certificate**: Client's certificate (CommonName identifies the user to the server)

### Security Notes

⚠️ **Never manually create or modify** the certificate fields - they form a cryptographic chain of trust  
⚠️ **Keep config files secure** - they contain private keys that authenticate to the C2 server  
⚠️ **Use unique configs per operator** - don't share config files between users

## Test Coverage

### Integration Tests

1. **TestSliverExfiltratorIntegration**
   - Tests exfiltration with various credential types
   - Verifies loot and credential storage
   - Tests with and without credential parsing

2. **TestStoreLootIntegration**
   - Verifies loot file creation and storage
   - Checks JSON structure and metadata

3. **TestStoreCredentialsIntegration**
   - Tests credential storage with plaintext passwords
   - Tests credential storage with hashes
   - Verifies credential formatting

4. **TestEndToEndExfiltration**
   - Complete workflow test with realistic findings
   - Tests AWS, GitHub, and Database credentials
   - Verifies metadata and finding counts

5. **TestRealSliverInstance** (opt-in)
   - Tests against a real Sliver C2 instance
   - Verifies actual network communication
   - Confirms data appears in Sliver's loot/cred stores

## Troubleshooting

### Real Instance Test Issues

**Test Skipped**
- The test is skipped by default when `SLIVER_CONFIG_PATH` is not set
- This is expected behavior - set the environment variable to run the test

**Invalid Config / Failed to Load Config**
- Ensure you're using a config file **generated by the Sliver server**
- Do not manually create or edit the certificate/key fields
- Regenerate the config if it's been corrupted: `sliver > new-operator --name <name> --lhost <ip>`
- Verify the config is valid JSON and contains all required fields

**Connection Failed**
- Ensure the Sliver server is running
- Verify the operator config path is correct (use full path, not wildcards)
- Check network connectivity to the server: `nc -zv <lhost> <lport>`
- Verify firewall rules allow connections to the lport
- Check the lhost/lport values in the config match the server's actual address

**Authentication Failed (mTLS Error)**
- The certificate chain is broken or invalid
- Regenerate the operator config from the server
- Do not copy/paste or manually edit certificate/key fields
- Ensure the server's CA hasn't changed (regenerating the server resets the CA)
- Verify the config file permissions are correct (readable by your user)

**"cannot unmarshal" or JSON Errors**
- The config file format is corrupted
- Ensure you're using the exact file generated by Sliver
- Check for copy/paste errors if the file was transferred
- Regenerate the config file from the server

## Writing New Tests

When adding new tests:

1. Use the `MockRPCClient` for unit/integration tests
2. Verify both loot and credential storage when applicable
3. Check JSON structure and metadata
4. Test error conditions
5. Use descriptive test names and subtests

Example:

```go
func TestNewFeature(t *testing.T) {
    mockRPC := &MockRPCClient{
        lootAddResponse: &clientpb.Loot{LootID: "test-loot-id"},
    }

    exfil := &SliverExfiltrator{
        rpc: mockRPC,
        // ... configure as needed
    }

    // Test your feature
    // Verify results using mockRPC.lootAddCalls
}
```

## Additional Resources

- [Sliver Documentation](https://github.com/BishopFox/sliver/wiki)
- [Pillager Documentation](../../README.md)
- [Exfil Package Documentation](../README.md)

